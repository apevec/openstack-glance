From 692b066c4a4b43f1e06325eb85e870c06c28d4ec Mon Sep 17 00:00:00 2001
From: "Kevin L. Mitchell" <kevin.mitchell@rackspace.com>
Date: Wed, 2 Nov 2011 11:18:16 -0500
Subject: [PATCH] Fix Keystone API skew issue with Glance client.

Fixes bug 878927 by applying Roman Sokolkov's patch.

(cherry picked from commit bc7aeb4a0a1295f90f7ea8824a1c8bf5313fafb7)

Change-Id: I9877131c7df65a58e75e6be47f29e9b0a0c2705e
---
 glance/common/auth.py      |   21 ++++++++++++++++-----
 glance/common/exception.py |    4 ++++
 2 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/glance/common/auth.py b/glance/common/auth.py
index 3f0e483..02cfee6 100644
--- a/glance/common/auth.py
+++ b/glance/common/auth.py
@@ -148,8 +148,15 @@ class KeystoneStrategy(BaseStrategy):
     def _v2_auth(self, token_url):
         creds = self.creds
 
-        creds = {"passwordCredentials": {"username": creds['username'],
-                                         "password": creds['password']}}
+        creds = {
+            "auth": {
+                "tenantName": creds['tenant'],
+                "passwordCredentials": {
+                    "username": creds['username'],
+                    "password": creds['password']
+                    }
+                }
+            }
 
         tenant = creds.get('tenant')
         if tenant:
@@ -163,12 +170,16 @@ class KeystoneStrategy(BaseStrategy):
                 token_url, 'POST', headers=headers, body=req_body)
 
         if resp.status == 200:
-            resp_auth = json.loads(resp_body)['auth']
+            resp_auth = json.loads(resp_body)['access']
 
             # FIXME(sirp): for now just using the first endpoint we get back
             # from the service catalog for glance, and using the public url.
-            glance_info = resp_auth['serviceCatalog']['glance']
-            glance_endpoint = glance_info[0]['publicURL']
+            for service in resp_auth['serviceCatalog']:
+                if service['name'] == 'glance':
+                    glance_endpoint = service['endpoints'][0]['publicURL']
+                    break
+            else:
+                raise exception.NoServiceEndpoint()
 
             self.management_url = glance_endpoint
             self.auth_token = resp_auth['token']['id']
diff --git a/glance/common/exception.py b/glance/common/exception.py
index 5d9bf19..d5d20ae 100644
--- a/glance/common/exception.py
+++ b/glance/common/exception.py
@@ -178,3 +178,7 @@ class StoreAddDisabled(GlanceException):
 
 class InvalidNotifierStrategy(GlanceException):
     message = "'%(strategy)s' is not an available notifier strategy."
+
+
+class NoServiceEndpoint(GlanceException):
+    message = _("Response from Keystone does not contain a Glance endpoint.")
-- 
1.7.6.5

